{"ast":null,"code":"/*\r\n * Copyright (c) 2015-present, Vitaly Tomilov\r\n *\r\n * See the LICENSE file at the top-level directory of this distribution\r\n * for licensing information.\r\n *\r\n * Removal or modification of this copyright notice is prohibited.\r\n */\n\nconst {\n  Events\n} = require('./events');\nconst npm = {\n  utils: require('./utils'),\n  text: require('./text')\n};\n\n////////////////////////////////////////////\n// Streams query data into any destination,\n// with the help of pg-query-stream library.\nfunction $stream(ctx, qs, initCB, config) {\n  const $p = config.promise;\n\n  // istanbul ignore next:\n  // we do not provide code coverage for the Native Bindings specifics\n  if (ctx.options.pgNative) {\n    return $p.reject(new Error(npm.text.nativeStreaming));\n  }\n  // Stream class was renamed again, see the following issue:\n  // https://github.com/brianc/node-postgres/issues/2412\n  if (!qs || !qs.constructor || qs.constructor.name !== 'QueryStream') {\n    // invalid or missing stream object;\n    return $p.reject(new TypeError(npm.text.invalidStream));\n  }\n  if (qs._reading || qs._closed) {\n    // stream object is in the wrong state;\n    return $p.reject(new Error(npm.text.invalidStreamState));\n  }\n  if (typeof initCB !== 'function') {\n    // parameter `initCB` must be passed as the initialization callback;\n    return $p.reject(new TypeError(npm.text.invalidStreamCB));\n  }\n  let error = Events.query(ctx.options, getContext());\n  if (error) {\n    error = getError(error);\n    Events.error(ctx.options, error, getContext());\n    return $p.reject(error);\n  }\n  const stream = ctx.db.client.query(qs);\n  stream.on('data', onData);\n  stream.on('error', onError);\n  stream.on('end', onEnd);\n  try {\n    initCB.call(this, stream); // the stream must be initialized during the call;\n  } catch (e) {\n    release();\n    error = getError(e);\n    Events.error(ctx.options, error, getContext());\n    return $p.reject(error);\n  }\n  const start = Date.now();\n  let resolve,\n    reject,\n    nRows = 0;\n  function onData(data) {\n    nRows++;\n    error = Events.receive(ctx.options, [data], undefined, getContext());\n    if (error) {\n      onError(error);\n    }\n  }\n  function onError(e) {\n    release();\n    stream.destroy();\n    e = getError(e);\n    Events.error(ctx.options, e, getContext());\n    reject(e);\n  }\n  function onEnd() {\n    release();\n    resolve({\n      processed: nRows,\n      // total number of rows processed;\n      duration: Date.now() - start // duration, in milliseconds;\n    });\n  }\n\n  function release() {\n    stream.removeListener('data', onData);\n    stream.removeListener('error', onError);\n    stream.removeListener('end', onEnd);\n  }\n  function getError(e) {\n    return e instanceof npm.utils.InternalError ? e.error : e;\n  }\n  function getContext() {\n    let client;\n    if (ctx.db) {\n      client = ctx.db.client;\n    } else {\n      error = new Error(npm.text.looseQuery);\n    }\n    return {\n      client,\n      dc: ctx.dc,\n      query: qs.cursor.text,\n      params: qs.cursor.values,\n      ctx: ctx.ctx\n    };\n  }\n  return $p((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n}\nmodule.exports = $stream;","map":{"version":3,"names":["Events","require","npm","utils","text","$stream","ctx","qs","initCB","config","$p","promise","options","pgNative","reject","Error","nativeStreaming","constructor","name","TypeError","invalidStream","_reading","_closed","invalidStreamState","invalidStreamCB","error","query","getContext","getError","stream","db","client","on","onData","onError","onEnd","call","e","release","start","Date","now","resolve","nRows","data","receive","undefined","destroy","processed","duration","removeListener","InternalError","looseQuery","dc","cursor","params","values","res","rej","module","exports"],"sources":["/Users/luna/Library/Mobile Documents/com~apple~CloudDocs/GitHub/paucamcal.github.io/AESP/node_modules/pg-promise/lib/stream.js"],"sourcesContent":["/*\r\n * Copyright (c) 2015-present, Vitaly Tomilov\r\n *\r\n * See the LICENSE file at the top-level directory of this distribution\r\n * for licensing information.\r\n *\r\n * Removal or modification of this copyright notice is prohibited.\r\n */\r\n\r\nconst {Events} = require('./events');\r\n\r\nconst npm = {\r\n    utils: require('./utils'),\r\n    text: require('./text')\r\n};\r\n\r\n////////////////////////////////////////////\r\n// Streams query data into any destination,\r\n// with the help of pg-query-stream library.\r\nfunction $stream(ctx, qs, initCB, config) {\r\n\r\n    const $p = config.promise;\r\n\r\n    // istanbul ignore next:\r\n    // we do not provide code coverage for the Native Bindings specifics\r\n    if (ctx.options.pgNative) {\r\n        return $p.reject(new Error(npm.text.nativeStreaming));\r\n    }\r\n    // Stream class was renamed again, see the following issue:\r\n    // https://github.com/brianc/node-postgres/issues/2412\r\n    if (!qs || !qs.constructor || qs.constructor.name !== 'QueryStream') {\r\n        // invalid or missing stream object;\r\n        return $p.reject(new TypeError(npm.text.invalidStream));\r\n    }\r\n    if (qs._reading || qs._closed) {\r\n        // stream object is in the wrong state;\r\n        return $p.reject(new Error(npm.text.invalidStreamState));\r\n    }\r\n    if (typeof initCB !== 'function') {\r\n        // parameter `initCB` must be passed as the initialization callback;\r\n        return $p.reject(new TypeError(npm.text.invalidStreamCB));\r\n    }\r\n\r\n    let error = Events.query(ctx.options, getContext());\r\n\r\n    if (error) {\r\n        error = getError(error);\r\n        Events.error(ctx.options, error, getContext());\r\n        return $p.reject(error);\r\n    }\r\n\r\n    const stream = ctx.db.client.query(qs);\r\n\r\n    stream.on('data', onData);\r\n    stream.on('error', onError);\r\n    stream.on('end', onEnd);\r\n\r\n    try {\r\n        initCB.call(this, stream); // the stream must be initialized during the call;\r\n    } catch (e) {\r\n        release();\r\n        error = getError(e);\r\n        Events.error(ctx.options, error, getContext());\r\n        return $p.reject(error);\r\n    }\r\n\r\n    const start = Date.now();\r\n    let resolve, reject, nRows = 0;\r\n\r\n    function onData(data) {\r\n        nRows++;\r\n        error = Events.receive(ctx.options, [data], undefined, getContext());\r\n        if (error) {\r\n            onError(error);\r\n        }\r\n    }\r\n\r\n    function onError(e) {\r\n        release();\r\n        stream.destroy();\r\n        e = getError(e);\r\n        Events.error(ctx.options, e, getContext());\r\n        reject(e);\r\n    }\r\n\r\n    function onEnd() {\r\n        release();\r\n        resolve({\r\n            processed: nRows, // total number of rows processed;\r\n            duration: Date.now() - start // duration, in milliseconds;\r\n        });\r\n    }\r\n\r\n    function release() {\r\n        stream.removeListener('data', onData);\r\n        stream.removeListener('error', onError);\r\n        stream.removeListener('end', onEnd);\r\n    }\r\n\r\n    function getError(e) {\r\n        return e instanceof npm.utils.InternalError ? e.error : e;\r\n    }\r\n\r\n    function getContext() {\r\n        let client;\r\n        if (ctx.db) {\r\n            client = ctx.db.client;\r\n        } else {\r\n            error = new Error(npm.text.looseQuery);\r\n        }\r\n        return {\r\n            client,\r\n            dc: ctx.dc,\r\n            query: qs.cursor.text,\r\n            params: qs.cursor.values,\r\n            ctx: ctx.ctx\r\n        };\r\n    }\r\n\r\n    return $p((res, rej) => {\r\n        resolve = res;\r\n        reject = rej;\r\n    });\r\n\r\n}\r\n\r\nmodule.exports = $stream;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}